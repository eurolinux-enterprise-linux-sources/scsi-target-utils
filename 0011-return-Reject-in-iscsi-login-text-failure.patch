From f2784d169c5136742cafaed669c238b320e3f47b Mon Sep 17 00:00:00 2001
From: Andy Grover <agrover@redhat.com>
Date: Sat, 10 Aug 2013 15:41:56 -0700
Subject: [PATCH] return-Reject-in-iscsi-login-text-failure

---
 usr/iscsi/iscsid.c    | 5 +++++
 usr/iscsi/iser_text.c | 5 +++++
 2 files changed, 10 insertions(+)

diff --git a/usr/iscsi/iscsid.c b/usr/iscsi/iscsid.c
index 4ed3711..144d2bd 100644
--- a/usr/iscsi/iscsid.c
+++ b/usr/iscsi/iscsid.c
@@ -341,6 +341,10 @@ static void text_scan_login(struct iscsi_connection *conn)
 			}
 
 			err = param_check_val(session_keys, idx, &val);
+			if (err) {
+				text_key_add_reject(conn, key);
+				continue;
+			}
 			if (idx == ISCSI_PARAM_MAX_XMIT_DLENGTH &&
 			    conn->session_type == SESSION_DISCOVERY)
 				conn->session_param[idx].val = val;
@@ -454,6 +458,7 @@ static void login_start(struct iscsi_connection *conn)
 	}
 	conn->initiator = strdup(name);
 	alias = text_key_find(conn, "InitiatorAlias");
+
 	session_type = text_key_find(conn, "SessionType");
 	target_name = text_key_find(conn, "TargetName");
 
diff --git a/usr/iscsi/iser_text.c b/usr/iscsi/iser_text.c
index 6a1e498..12ebc42 100644
--- a/usr/iscsi/iser_text.c
+++ b/usr/iscsi/iser_text.c
@@ -284,6 +284,11 @@ static void iser_login_oper_scan(struct iscsi_connection *iscsi_conn,
 			}
 
 			err = param_check_val(session_keys, idx, &val);
+			if (err) {
+				iser_text_key_add_reject(iscsi_conn, tx_pdu, key);
+				continue;
+			}
+
 			param_set_val(session_keys, iscsi_conn->session_param, idx, &val);
 
 			switch (iscsi_conn->session_param[idx].state) {
-- 
1.9.0

